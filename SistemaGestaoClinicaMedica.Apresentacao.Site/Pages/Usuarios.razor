@page "/usuarios"
@attribute [Authorize(Roles = "Administrador")]

@using SistemaGestaoClinicaMedica.Aplicacao.DTO;
@using SistemaGestaoClinicaMedica.Apresentacao.Site.Extensions;
@using SistemaGestaoClinicaMedica.Apresentacao.Site.Servicos;
@inherits TableBase<IUsuariosServico, UsuarioDTO, Guid>

<HeaderComponent Title="Usuários"
                 NewRoute="usuarios/novo"
                 SearchPlaceholder="Informe o nome ou email do usuário"
                 SearchWithButton="true"
                 SearchVisibled="true"
                 OnSearch="BuscarAsync">
    <div class="row">
        <div class="form-group col-md-6 offset-md-6">
            <label for="ativo">Ativo</label>
            <select class="form-control" id="ativo" @onchange="SelecionaAtivoAsync">
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>
        </div>
    </div>
</HeaderComponent>

<TableComponent Items="dtos">
    <TableHeader>
        <th>Nome</th>
        <th>Cargo</th>
        <th>Telefone</th>
        <th>Ativo</th>
        <th></th>
    </TableHeader>
    <RowTemplate>
        <td>@context.Nome</td>
        <td>@context.Cargo.Nome</td>
        <td>@context.Telefone</td>
        <td>@(context.Ativo ? "Sim" : "Não")</td>
        <td>
            <button @onclick="(e => EditarUsuario(context.Cargo.Id, context.Id))" class="btn"><span class="oi oi-pencil" aria-hidden="true"></span></button>

            @if (context.Ativo && !context.ESuperUsuario)
            {
                <ConfirmDialogComponent Id="@context.Id.ToString()"
                                        Message="@($"O usuário {context.Nome} será inativado, deseja prosseguir?")"
                                        ActionButtonText="Excluir"
                                        OnActionButton="@(e => Deletar(e, context.Id))">
                    <span class="oi oi-trash text-danger" aria-hidden="true"></span>
                </ConfirmDialogComponent>
            }
        </td>
    </RowTemplate>
</TableComponent>

@code{
    private bool _ativo;

    private async Task EditarUsuario(string cargoId, Guid id)
    {
        await LocalStorage.CriaUsuarioCargoIdEdicaoLocalStorageAsync(cargoId);
        NavigationManager.NavigateTo($"usuarios/{id}");
    }

    private async Task BuscarAsync(string busca)
    {
        dtos = await HttpServico.GetTudoComFiltrosAsync(busca, _ativo);
        StateHasChanged();
    }

    private async Task SelecionaAtivoAsync(ChangeEventArgs args)
    {
        _ativo = args.Value.ToString().Equals("Sim");
        dtos = await HttpServico.GetTudoComFiltrosAsync(null, _ativo);
        StateHasChanged();
    }
}